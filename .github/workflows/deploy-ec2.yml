name: ğŸš€ Deploy to AWS EC2 Micro Instance

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: openlearn_test
        options: >-
          --health-cmd pg_isready
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” Run ESLint
      run: npm run lint || true

    - name: ğŸ—ï¸ Build TypeScript
      run: npm run build

    - name: ğŸ—„ï¸ Setup test database
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/openlearn_test
      run: |
        npx prisma generate
        npx prisma migrate deploy

    - name: ğŸ§ª Run tests
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/openlearn_test
        JWT_SECRET: test-secret
        JWT_REFRESH_SECRET: test-refresh-secret
      run: npm test || true

  deploy-micro:
    name: ğŸš€ Deploy to EC2 Micro Instance
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_PRIVATE_KEY }}

    - name: ğŸ“‹ Create deployment script
      run: |
        cat > deploy-micro-to-ec2.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Colors
        GREEN='\033[0;32m'
        BLUE='\033[0;34m'
        RED='\033[0;31m'
        NC='\033[0m'
        
        log() {
            echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
        }
        
        success() {
            echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] âœ“ $1${NC}"
        }
        
        error() {
            echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] âœ— $1${NC}"
        }
        
        DEPLOY_DIR="/home/ubuntu/openlearn-backend"
        
        log "ğŸš€ Starting micro deployment to EC2..."
        
        # Create directory if it doesn't exist
        mkdir -p $DEPLOY_DIR
        cd $DEPLOY_DIR
        
        # Pull latest code
        if [ -d ".git" ]; then
            log "ğŸ“¥ Pulling latest code..."
            git pull origin master || git pull origin main
        else
            log "ğŸ“¥ Cloning repository..."
            git clone https://github.com/openlearnnitj/openlearn-backend.git .
        fi
        
        # Ensure environment file exists
        if [ ! -f ".env" ]; then
            log "âš™ï¸ Creating default environment file..."
            if [ -f "environments/.env.micro" ]; then
                cp environments/.env.micro .env
            else
                error "âŒ No environment template found!"
                exit 1
            fi
            error "âŒ Please update .env with your actual values!"
            exit 1
        fi
        
        # Fix Docker permissions if needed
        if ! docker ps >/dev/null 2>&1; then
            log "ğŸ”§ Fixing Docker permissions..."
            sudo usermod -aG docker ubuntu || true
            newgrp docker || true
        fi
        
        # Run deployment
        log "ğŸ—ï¸ Running micro deployment..."
        chmod +x deploy.sh
        ./deploy.sh
        
        success "âœ… Micro deployment completed!"
        EOF
        chmod +x deploy-micro-to-ec2.sh

    - name: ğŸ“¤ Copy deployment script to EC2
      run: |
        scp -o StrictHostKeyChecking=no deploy-micro-to-ec2.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/

    - name: ğŸš€ Execute deployment
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash /tmp/deploy-micro-to-ec2.sh'

    - name: ğŸ¥ Health check
      run: |
        echo "ğŸ¥ Performing health check..."
        sleep 30
        
        for i in {1..5}; do
          if ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'curl -f -s http://localhost:3000/health > /dev/null'; then
            echo "âœ… Health check passed!"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ Health check failed after 5 attempts"
            exit 1
          fi
          echo "â³ Health check attempt $i failed, retrying in 10s..."
          sleep 10
        done

    - name: ğŸ§¹ Cleanup
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'rm -f /tmp/deploy-micro-to-ec2.sh'

  notify:
    name: ğŸ“¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-micro]
    if: always()
    
    steps:
    - name: ğŸ“¢ Deployment Success Notification
      if: needs.deploy-micro.result == 'success'
      run: |
        echo "ğŸ‰ Micro deployment to EC2 completed successfully!"
        echo "ğŸ“ˆ Health: http://${{ secrets.EC2_HOST }}:3000/health"

    - name: ğŸ“¢ Deployment Failure Notification
      if: needs.deploy-micro.result == 'failure'
      run: |
        echo "âŒ Micro deployment to EC2 failed!"
        echo "ğŸ”„ Check the deployment logs for details"
